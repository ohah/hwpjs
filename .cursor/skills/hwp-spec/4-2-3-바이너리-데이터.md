# 4.2.3. 바이너리 데이터

Tag ID: HWPTAG_BIN_DATA

그림, OLE 등의 바이너리 데이터 아이템에 대한 정보를 담는 레코드이다.

**표 17: 바이너리 데이터**

| 자료형 | 길이(바이트) | 설명 |
|---|---|---|
| | | 그림, OLE 등의 바이너리 데이터 아이템에 대한 정보 |
| UINT16 | 2 | 속성(표 18 참조) |
| WORD | 2 | Type이 "LINK"일 때, 연결 파일의 절대 경로 길이 (len1) |
| WCHAR array[len1] | 2×len1 | Type이 "LINK"일 때, 연결 파일의 절대 경로 |
| WORD | 2 | Type이 "LINK"일 때, 연결 파일의 상대 경로 길이 (len2) |
| WCHAR array[len2] | 2×len2 | Type이 "LINK"일 때, 연결 파일의 상대 경로 |
| UINT16 | 2 | Type이 "EMBEDDING"이거나 "STORAGE"일 때, BINDATASTORAGE에 저장된 바이너리 데이터의 아이디 |
| WORD | 2 | Type이 "EMBEDDING"일 때, 바이너리 데이터의 형식 이름의 길이 (len3) |
| WCHAR array[len3] | 2×len3 | Type이 "EMBEDDING"일 때 extension("." 제외)<br>- 그림의 경우: jpg, bmp, gif<br>- OLE의 경우: ole |
| 전체 길이 | 가변 | `10 + (2×len1) + (2×len2) + (2×len3) 바이트` |

**표 18: 바이너리 데이터 속성**

| 범위 | 구분 | 값 | 설명 |
|---|---|---|---|
| bit 0-3 | Type | 0x0000 | LINK, 그림 외부 파일 참조 |
| | | 0x0001 | EMBEDDING, 그림 파일 포함 |
| | | 0x0002 | STORAGE, OLE 포함 |
| bit 4-5 | 압축 | 0x0000 | 스토리지의 디폴트 모드 따라감 |
| | | 0x0010 | 무조건 압축 |
| | | 0x0020 | 무조건 압축하지 않음 |
| bit 8-9 | 상태 | 0x0000 | 아직 access 된 적이 없는 상태 |
| | | 0x0100 | access에 성공하여 파일을 찾은 상태 |
| | | 0x0200 | access가 실패한 에러 상태 |
| | | 0x0300 | 링크 access가 실패했으나 무시된 상태 |

---

## BinData 스토리지 및 압축 (3.2.5 참고)

표 2에 따르면 BinData 스토리지의 스트림은 압축되어 저장된다. 실제 구현에서는 CFB에서 스트림을 읽은 후 **압축 해제가 필요**하다.

- **압축 형식**: raw deflate (zlib의 deflate 알고리즘, windowBits: -15)
- **압축 해제**: zlib의 `decompress(..., -15)` 또는 동등한 함수 사용
- **레거시 참고**: hwpjs.js `pako.inflate(data.content, { windowBits: -15 })`, pyhwp `zlib.decompress(compressed_data, -15)`

---

## 실제 구현 시 주의사항 (Implementation Notes)

스펙 문서에는 BinData 스토리지 내 스트림의 정확한 경로 형식이 명시되어 있지 않다. 실제 구현에서는 **표 17의 HWPTAG_BIN_DATA 레코드**를 사용하여 스트림을 찾는다.

1. **EMBEDDING 타입**: `binary_data_id`와 `extension` 정보 사용
   - 스트림 이름: `BIN{id:04X}` (16진수 4자리, 대문자)
   - 시도 경로: `BinData/BIN{id:04X}`, `Root Entry/BinData/BIN{id:04X}`, `BIN{id:04X}`
   - 또는 `BinData/BIN{id:04X}.{extension}`, `Root Entry/BinData/BIN{id:04X}.{extension}` (표 17의 extension 사용)

2. **STORAGE 타입**: `binary_data_id`만 사용 (extension 없음)
   - 스트림 이름: `BIN{id:04X}`
   - 시도 경로: `BinData/BIN{id:04X}`, `Root Entry/BinData/BIN{id:04X}`, `BIN{id:04X}`

3. **LINK 타입**: BinData 스토리지에 저장되지 않으므로 건너뜀

표 17의 `extension` 필드는 EMBEDDING 타입일 때 바이너리 데이터의 형식 정보를 제공하며, 스트림 경로 구성에 활용할 수 있다.

**압축 해제**: CFB에서 스트림을 읽은 후 raw deflate 형식으로 압축 해제해야 한다. 압축 해제 실패 시 원본 데이터를 사용하거나 에러를 처리해야 한다.
